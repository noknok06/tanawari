{% extends 'base.html' %}
{% load range_filter %}

{% block title %}{{ shelf.name }} - 棚割り編集{% endblock %}

{% block extra_css %}
<style>
.shelf-container {
    background-color: #f8f9fa;
    border: 2px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    margin: 1rem 0;
    position: relative;
    width: 100%;
    overflow: hidden;
}

.shelf-grid {
    display: grid;
    gap: 1px;
    width: 100%;
    height: auto;
    position: relative;
    aspect-ratio: auto;
}

/* コピーモードのスタイル */
.copy-mode {
    cursor: copy !important;
}

.copy-mode .shelf-cell:not(.occupied) {
    cursor: copy !important;
    transition: all 0.2s ease;
}

.copy-drop-zone-active {
    border: 2px dashed #198754 !important;
    background-color: rgba(25, 135, 84, 0.1) !important;
    transform: scale(1.05);
}

.copy-drop-zone-active:hover {
    background-color: rgba(25, 135, 84, 0.2) !important;
    border-color: #146c43 !important;
}

/* ドラッグモードのスタイル */
.dragging-mode {
    cursor: grabbing !important;
}

.dragging-mode .shelf-cell:not(.occupied) {
    cursor: copy !important;
    transition: all 0.2s ease;
}

.drop-zone-active {
    border: 2px dashed #0d6efd !important;
    background-color: rgba(13, 110, 253, 0.1) !important;
    transform: scale(1.05);
}

.drop-zone-active:hover {
    background-color: rgba(13, 110, 253, 0.2) !important;
    border-color: #0056b3 !important;
}

.drag-preview {
    position: fixed;
    pointer-events: none;
    z-index: 9999 !important;
    background: white;
    border: 2px solid #0d6efd;
    border-radius: 8px;
    padding: 8px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    transform: rotate(5deg);
    opacity: 0.9;
}

/* セルホバー効果 */
.shelf-cell.occupied {
    background-color: #f8f9fa;
    border-color: #dee2e6;
    cursor: grab;
}

.shelf-cell.occupied:hover {
    transform: scale(1.02);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.shelf-cell {
    aspect-ratio: 1;
    border: 1px solid #dee2e6;
    background-color: white;
    border-radius: 2px;
    position: relative;
    min-height: 40px;
    max-height: 80px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.shelf-cell:hover:not(.occupied) {
    border-color: #0d6efd;
    background-color: #e7f1ff;
    transform: scale(1.02);
}

.shelf-cell.occupied {
    background-color: #f8f9fa;
    border-color: #dee2e6;
    cursor: grab;
}

.shelf-cell.occupied:active {
    cursor: grabbing;
}

.shelf-cell.occupied.own-product {
    background-color: #d4edda;
    border-color: #c3e6cb;
}

.shelf-cell.occupied.competitor-product {
    background-color: #fff3cd;
    border-color: #ffeaa7;
}

.shelf-cell.drag-over {
    border: 2px dashed #0d6efd !important;
    background-color: #e7f1ff !important;
    transform: scale(1.05);
}

.shelf-cell.invalid-drop {
    border: 2px dashed #dc3545 !important;
    background-color: #f8d7da !important;
}

.product-info {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    pointer-events: none;
    padding: 2px;
}

.product-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 2px;
}

.product-name {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    font-size: 0.6rem;
    padding: 1px 2px;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    opacity: 0;
    transition: opacity 0.2s;
}

.shelf-cell:hover .product-name {
    opacity: 1;
}

.face-count {
    position: absolute;
    top: 2px;
    right: 2px;
    background-color: #0d6efd;
    color: white;
    border-radius: 50%;
    width: 16px;
    height: 16px;
    font-size: 0.6rem;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    font-weight: bold;
}

.face-count.editable {
    cursor: pointer;
    transition: all 0.2s;
}

.face-count.editable:hover {
    background-color: #0056b3;
    transform: scale(1.1);
}

.empty-cell-hint {
    color: #6c757d;
    font-size: 0.7rem;
    text-align: center;
    opacity: 0;
    transition: opacity 0.2s;
}

.shelf-cell:hover .empty-cell-hint {
    opacity: 1;
}

.product-list {
    max-height: 500px;
    overflow-y: auto;
}

.product-item {
    cursor: grab;
    transition: all 0.2s;
    user-select: none;
}

.product-item:hover {
    background-color: #f8f9fa;
    transform: translateX(5px);
}

.product-item:active {
    cursor: grabbing;
}

.product-item.dragging {
    opacity: 0.5;
    transform: rotate(5deg);
}

.ghost-product {
    opacity: 0.3;
    transform: scale(0.9);
}

.drag-preview {
    position: fixed;
    pointer-events: none;
    z-index: 1000;
    background: white;
    border: 2px solid #0d6efd;
    border-radius: 8px;
    padding: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: rotate(5deg);
}

.shelf-coordinates {
    position: absolute;
    top: -25px;
    left: 0;
    right: 0;
    display: flex;
    justify-content: space-between;
    font-size: 0.7rem;
    color: #6c757d;
}

.shelf-row-labels {
    position: absolute;
    left: -30px;
    top: 0;
    bottom: 0;
    display: flex;
    flex-direction: column;
    justify-content: space-around;
    font-size: 0.7rem;
    color: #6c757d;
}

.toolbar {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 0.5rem;
    margin-bottom: 1rem;
    display: flex;
    gap: 0.5rem;
    align-items: center;
    flex-wrap: wrap;
}

.toolbar-group {
    display: flex;
    gap: 0.25rem;
    align-items: center;
    padding: 0 0.5rem;
    border-right: 1px solid #dee2e6;
}

.toolbar-group:last-child {
    border-right: none;
}

.quick-action-btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
    border-radius: 0.25rem;
}

.placement-stats {
    background: #f8f9fa;
    border-radius: 0.375rem;
    padding: 1rem;
    margin-bottom: 1rem;
}

.stat-item {
    text-align: center;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #0d6efd;
}

.context-menu {
    position: fixed;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1050;
    min-width: 150px;
    display: none;
}

.context-menu-item {
    padding: 0.5rem 1rem;
    cursor: pointer;
    border-bottom: 1px solid #f8f9fa;
    transition: background-color 0.2s;
}

.context-menu-item:hover {
    background-color: #f8f9fa;
}

.context-menu-item:last-child {
    border-bottom: none;
}

.context-menu-item.danger:hover {
    background-color: #f8d7da;
    color: #721c24;
}

.modal-product-item {
    cursor: pointer;
}

.product-card {
    transition: all 0.2s ease;
    border: 1px solid #dee2e6;
}

.product-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    border-color: #0d6efd;
}

.product-card:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.no-image-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f8f9fa;
    border-radius: 2px;
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1>{{ shelf.name }}</h1>
        <p class="text-muted mb-0">
            {{ shelf.width }}×{{ shelf.height }}×{{ shelf.depth }}cm | {{ shelf.rows }}段×{{ shelf.columns }}列
        </p>
    </div>
    <div class="btn-group">
        <button class="btn btn-outline-primary" onclick="saveShelfLayout()">
            <i class="bi bi-save"></i> 保存
        </button>
        <button class="btn btn-outline-secondary" onclick="clearShelf()">
            <i class="bi bi-trash"></i> 全削除
        </button>
        <a href="{% url 'shelves:shelf_edit' shelf.pk %}" class="btn btn-outline-secondary">
            <i class="bi bi-pencil"></i> 棚設定編集
        </a>
        <a href="{% url 'shelves:shelf_list' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> 棚一覧
        </a>
    </div>
</div>

<!-- CSRFトークンの隠しフィールド -->
<form style="display: none;">
    {% csrf_token %}
</form>

<!-- ツールバー -->
<div class="toolbar">
    <div class="toolbar-group">
        <label class="form-label mb-0 me-2">表示:</label>
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="showOwnProducts" checked>
            <label class="form-check-label" for="showOwnProducts">自社商品</label>
        </div>
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="showCompetitorProducts" checked>
            <label class="form-check-label" for="showCompetitorProducts">競合商品</label>
        </div>
    </div>
    <div class="toolbar-group">
        <label class="form-label mb-0 me-2">グリッド:</label>
        <button class="btn btn-sm btn-outline-secondary quick-action-btn" onclick="toggleGrid()">
            <i class="bi bi-grid"></i> グリッド表示
        </button>
        <button class="btn btn-sm btn-outline-secondary quick-action-btn" onclick="toggleCoordinates()">
            <i class="bi bi-compass"></i> 座標表示
        </button>
    </div>
    <div class="toolbar-group">
        <button class="btn btn-sm btn-outline-primary quick-action-btn" onclick="autoArrange()">
            <i class="bi bi-magic"></i> 自動配置
        </button>
        <button class="btn btn-sm btn-outline-warning quick-action-btn" onclick="undoLastAction()">
            <i class="bi bi-arrow-counterclockwise"></i> 元に戻す
        </button>
    </div>
</div>

<!-- 配置統計 -->
<div class="placement-stats">
    <div class="row text-center">
        <div class="col-md-3 stat-item">
            <div class="stat-value" id="totalProducts">{{ placements|length }}</div>
            <small class="text-muted">配置商品数</small>
        </div>
        <div class="col-md-3 stat-item">
            <div class="stat-value text-success" id="ownProducts">0</div>
            <small class="text-muted">自社商品</small>
        </div>
        <div class="col-md-3 stat-item">
            <div class="stat-value text-warning" id="competitorProducts">0</div>
            <small class="text-muted">競合商品</small>
        </div>
        <div class="col-md-3 stat-item">
            <div class="stat-value text-info" id="occupancyRate">0%</div>
            <small class="text-muted">占有率</small>
        </div>
    </div>
</div>

<div class="row" id="mainLayout">
    <!-- 棚割りエリア -->
    <div class="col-12" id="shelfArea">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">棚割りレイアウト</h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" onclick="toggleProductPanel()">
                        <i class="bi bi-list"></i> 商品一覧
                    </button>
                    <button class="btn btn-outline-secondary" onclick="zoomIn()">
                        <i class="bi bi-zoom-in"></i>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="zoomOut()">
                        <i class="bi bi-zoom-out"></i>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="resetZoom()">
                        <i class="bi bi-arrows-fullscreen"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-2">
                <div class="shelf-container" id="shelfContainer">
                    <!-- 座標ラベル -->
                    <div class="shelf-coordinates" id="shelfCoordinates" style="display: none;">
                        {% for col in shelf.columns|range %}
                            <span>{{ col|add:1 }}</span>
                        {% endfor %}
                    </div>
                    <div class="shelf-row-labels" id="shelfRowLabels" style="display: none;">
                        {% for row in shelf.rows|range %}
                            <span>{{ row|add:1 }}</span>
                        {% endfor %}
                    </div>
                    
                    <div class="shelf-grid" id="shelf-grid" 
                         style="grid-template-rows: repeat({{ shelf.rows }}, 1fr); grid-template-columns: repeat({{ shelf.columns }}, 1fr);">
                        {% for row in grid %}
                            {% for cell in row %}
                                <div class="shelf-cell {% if cell %}occupied {% if cell.product.is_own_product %}own-product{% else %}competitor-product{% endif %}{% endif %}"
                                     data-row="{{ forloop.parentloop.counter0 }}" 
                                     data-column="{{ forloop.counter0 }}"
                                     {% if cell %}data-placement-id="{{ cell.id }}" data-product-id="{{ cell.product.id }}"{% endif %}
                                     ondblclick="handleCellDoubleClick(this)"
                                     onclick="handleCellClick(this)"
                                     {% if cell %}oncontextmenu="handleCellRightClick(event, this)"{% endif %}>
                                    {% if cell %}
                                        <div class="product-info">
                                            {% if cell.product.image %}
                                                <img src="{{ cell.product.image.url }}" alt="{{ cell.product.product_name }}" class="product-image">
                                            {% else %}
                                                <div class="no-image-placeholder">
                                                    <i class="bi bi-image" style="font-size: 1.5rem; color: #dee2e6;"></i>
                                                </div>
                                            {% endif %}
                                            <div class="product-name">{{ cell.product.product_name|truncatechars:15 }}</div>
                                        </div>
                                        {% if cell.face_count > 1 %}
                                            <div class="face-count editable" onclick="editFaceCount({{ cell.id }}, {{ cell.face_count }}); event.stopPropagation();">{{ cell.face_count }}</div>
                                        {% endif %}
                                    {% else %}
                                        <div class="empty-cell-hint">
                                            <i class="bi bi-plus-circle"></i><br>
                                            <span style="font-size: 0.6rem;">クリック/ダブルクリック</span>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        {% endfor %}
                    </div>
                </div>
                
                <!-- 凡例とヘルプ -->
                <div class="mt-2 d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted">
                            <span class="badge" style="background-color: #d4edda; color: #155724;">自社商品</span>
                            <span class="badge" style="background-color: #fff3cd; color: #856404;">競合商品</span>
                        </small>
                    </div>
                    <div id="helpText">
                        <small class="text-muted">
                            商品一覧ボタン → ドラッグ&ドロップ | セルをドラッグでコピー | ダブルクリックで選択
                        </small>
                    </div>
                </div>
                
                <!-- ドラッグモード中のヘルプ（非表示） -->
                <div id="dragModeHelp" class="alert alert-info mt-2" style="display: none;">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-info-circle me-2"></i>
                        <div>
                            <strong>ドラッグモード</strong>: 
                            空いているセルをクリックして商品を配置 | 
                            <kbd>Esc</kbd>でキャンセル
                        </div>
                    </div>
                </div>
                
                <!-- コピーモード中のヘルプ（非表示） -->
                <div id="copyModeHelp" class="alert alert-success mt-2" style="display: none;">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-copy me-2"></i>
                        <div>
                            <strong>コピーモード</strong>: 
                            空いているセルをクリックして商品をコピー配置 | 
                            <kbd>Esc</kbd>でキャンセル
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 商品リストパネル（サイドパネル） -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="productPanel" style="width: 400px;">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title">商品一覧</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body p-0">
        <div class="p-3 border-bottom">
            <div class="input-group input-group-sm">
                <input type="text" class="form-control" id="productSearch" placeholder="商品検索...">
                <button class="btn btn-outline-secondary" onclick="clearSearch()">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        </div>
        <div class="product-list" id="productList" style="height: calc(100vh - 200px); overflow-y: auto;">
            {% for product in products %}
                <div class="product-item p-2 border-bottom" 
                     draggable="true" 
                     data-product-id="{{ product.id }}"
                     data-product-name="{{ product.product_name }}"
                     data-maker-name="{{ product.maker.name }}"
                     data-is-own="{{ product.is_own_product|yesno:'true,false' }}"
                     data-search-text="{{ product.product_name|lower }} {{ product.maker.name|lower }}">
                    <div class="d-flex align-items-center">
                        {% if product.image %}
                            <img src="{{ product.image.url }}" alt="{{ product.product_name }}" 
                                 class="me-2" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;">
                        {% else %}
                            <div class="me-2 bg-light d-flex align-items-center justify-content-center" 
                                 style="width: 40px; height: 40px; border-radius: 4px;">
                                <i class="bi bi-image text-muted"></i>
                            </div>
                        {% endif %}
                        <div class="flex-grow-1">
                            <div class="fw-bold" style="font-size: 0.9rem;">{{ product.product_name|truncatechars:25 }}</div>
                            <small class="text-muted">{{ product.maker.name }}</small>
                            {% if product.is_own_product %}
                                <span class="badge bg-success ms-1">自社</span>
                            {% else %}
                                <span class="badge bg-warning ms-1">競合</span>
                            {% endif %}
                        </div>
                        <div class="text-muted">
                            <i class="bi bi-grip-vertical"></i>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- 商品選択モーダル -->
<div class="modal fade" id="productSelectModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">商品を選択</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="row">
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="modalProductSearch" placeholder="商品名、メーカー名で検索...">
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="modalCategoryFilter">
                                <option value="">すべてのカテゴリ</option>
                                {% for category in categories %}
                                    <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="row" id="modalProductList" style="max-height: 400px; overflow-y: auto;">
                    {% for product in products %}
                        <div class="col-md-6 col-lg-4 mb-3 modal-product-item" 
                             data-product-id="{{ product.id }}"
                             data-product-name="{{ product.product_name }}"
                             data-maker-name="{{ product.maker.name }}"
                             data-category-id="{{ product.category.id }}"
                             data-is-own="{{ product.is_own_product|yesno:'true,false' }}"
                             data-search-text="{{ product.product_name|lower }} {{ product.maker.name|lower }}"
                             onclick="selectProductFromModal(this)">
                            <div class="card h-100 product-card">
                                <div class="card-body p-2 text-center">
                                    {% if product.image %}
                                        <img src="{{ product.image.url }}" alt="{{ product.product_name }}" 
                                             class="img-fluid mb-2" style="height: 80px; object-fit: cover;">
                                    {% else %}
                                        <div class="bg-light d-flex align-items-center justify-content-center mb-2" 
                                             style="height: 80px;">
                                            <i class="bi bi-image text-muted" style="font-size: 2rem;"></i>
                                        </div>
                                    {% endif %}
                                    <h6 class="card-title mb-1" style="font-size: 0.8rem;">{{ product.product_name|truncatechars:20 }}</h6>
                                    <small class="text-muted d-block">{{ product.maker.name }}</small>
                                    {% if product.is_own_product %}
                                        <span class="badge bg-success">自社</span>
                                    {% else %}
                                        <span class="badge bg-warning">競合</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <input type="hidden" id="modalTargetRow">
                <input type="hidden" id="modalTargetColumn">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
            </div>
        </div>
    </div>
</div>

<!-- 商品配置モーダル -->
<div class="modal fade" id="placementModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">商品配置</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="placementForm">
                    {% csrf_token %}
                    <input type="hidden" id="modalShelfId" value="{{ shelf.id }}">
                    <input type="hidden" id="modalProductId">
                    <input type="hidden" id="modalRow">
                    <input type="hidden" id="modalColumn">
                    
                    <div class="mb-3">
                        <label class="form-label">商品</label>
                        <div id="modalProductInfo" class="p-2 bg-light rounded"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">配置位置</label>
                        <div id="modalPosition" class="p-2 bg-light rounded"></div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalFaceCount" class="form-label">フェース数</label>
                                <input type="number" class="form-control" id="modalFaceCount" min="1" value="1">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalSpanRows" class="form-label">占有段数</label>
                                <input type="number" class="form-control" id="modalSpanRows" min="1" value="1">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="modalSpanColumns" class="form-label">占有列数</label>
                        <input type="number" class="form-control" id="modalSpanColumns" min="1" value="1">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="confirmPlacement()">配置</button>
            </div>
        </div>
    </div>
</div>

<!-- 商品削除確認モーダル -->
<div class="modal fade" id="removeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">商品削除確認</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>この位置から商品を削除しますか？</p>
                <div id="removeProductInfo" class="p-2 bg-light rounded"></div>
                <input type="hidden" id="removePlacementId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-danger" onclick="confirmRemoval()">削除</button>
            </div>
        </div>
    </div>
</div>

<!-- コンテキストメニュー -->
<div class="context-menu" id="contextMenu">
    <div class="context-menu-item" onclick="editProduct()">
        <i class="bi bi-pencil me-2"></i>商品情報編集
    </div>
    <div class="context-menu-item" onclick="duplicateProduct()">
        <i class="bi bi-copy me-2"></i>複製
    </div>
    <div class="context-menu-item" onclick="moveProduct()">
        <i class="bi bi-arrows-move me-2"></i>移動
    </div>
    <div class="context-menu-item danger" onclick="removeProduct()">
        <i class="bi bi-trash me-2"></i>削除
    </div>
</div>

<!-- ドラッグプレビュー -->
<div class="drag-preview" id="dragPreview" style="display: none;"></div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
let draggedProduct = null;
let selectedCell = null;
let actionHistory = [];
let currentZoom = 1;
let contextMenuTarget = null;

// 商品パネルの表示切り替え
function toggleProductPanel() {
    const productPanel = document.getElementById('productPanel');
    const offcanvas = new bootstrap.Offcanvas(productPanel);
    offcanvas.show();
    
    // オフキャンバス表示後にドラッグ&ドロップを再初期化
    productPanel.addEventListener('shown.bs.offcanvas', function() {
        console.log('Offcanvas shown, reinitializing drag and drop');
        initializeProductListDragDrop();
    }, { once: true });
}

// 商品リスト専用のドラッグ&ドロップ初期化
function initializeProductListDragDrop() {
    const productListElement = document.getElementById('productList');
    
    if (!productListElement) {
        console.warn('Product list element not found');
        return;
    }
    
    // 既存のSortableがあれば破棄
    if (productListElement.sortable) {
        productListElement.sortable.destroy();
    }
    
    // 新しいSortableを作成
    const sortable = new Sortable(productListElement, {
        group: {
            name: 'products',
            pull: 'clone',
            put: false
        },
        sort: false,
        animation: 150,
        ghostClass: 'ghost-product',
        onStart: function(evt) {
            const item = evt.item;
            draggedProduct = {
                id: item.dataset.productId,
                name: item.dataset.productName,
                maker: item.dataset.makerName,
                isOwn: item.dataset.isOwn === 'true',
                element: item
            };
            
            console.log('Drag started from offcanvas:', draggedProduct);
            
            // offcanvasを閉じる
            const offcanvasElement = document.getElementById('productPanel');
            const offcanvasInstance = bootstrap.Offcanvas.getInstance(offcanvasElement);
            if (offcanvasInstance) {
                offcanvasInstance.hide();
            }
            
            // ドラッグプレビューを作成
            createDragPreview(draggedProduct);
            
            // ドラッグモードを有効にする
            document.body.classList.add('dragging-mode');
            
            // セルにドロップゾーンのスタイルを追加
            document.querySelectorAll('.shelf-cell:not(.occupied)').forEach(cell => {
                cell.classList.add('drop-zone-active');
            });
        },
        onEnd: function(evt) {
            console.log('Drag ended');
            hideDragPreview();
            
            // ドラッグモードを無効にする
            document.body.classList.remove('dragging-mode');
            
            // ドロップゾーンのスタイルを削除
            document.querySelectorAll('.shelf-cell').forEach(cell => {
                cell.classList.remove('drop-zone-active');
            });
            
            // draggedProductをリセット（少し遅延を入れる）
            setTimeout(() => {
                draggedProduct = null;
            }, 100);
        }
    });
    
    // Sortableインスタンスを保存
    productListElement.sortable = sortable;
    
    console.log('Product list drag and drop initialized');
}

// 初期化
document.addEventListener('DOMContentLoaded', function() {
    initializeDragAndDrop();
    updateStats();
    setupProductSearch();
    setupKeyboardShortcuts();
    setupModalProductSearch();
    adjustShelfLayout();
    
    // 初期状態で商品リストのドラッグ&ドロップを有効化
    initializeProductListDragDrop();
});

// 棚レイアウトの調整
function adjustShelfLayout() {
    const container = document.getElementById('shelfContainer');
    const grid = document.getElementById('shelf-grid');
    
    if (!container || !grid) return;
    
    // コンテナの幅に合わせてセルサイズを調整
    function resizeGrid() {
        const containerWidth = container.offsetWidth - 32; // パディング分を引く
        const columns = {{ shelf.columns }};
        const rows = {{ shelf.rows }};
        
        // セルサイズを計算（最小40px、最大100px）
        const cellSize = Math.min(Math.max(containerWidth / columns - 2, 40), 100);
        
        grid.style.gridTemplateColumns = `repeat(${columns}, ${cellSize}px)`;
        grid.style.gridTemplateRows = `repeat(${rows}, ${cellSize}px)`;
        
        console.log('Grid resized:', { containerWidth, cellSize, columns, rows });
    }
    
    // 初期サイズ設定
    resizeGrid();
    
    // ウィンドウリサイズ時に再調整
    window.addEventListener('resize', resizeGrid);
}

// セルダブルクリックハンドラー
function handleCellDoubleClick(cell) {
    const row = parseInt(cell.dataset.row);
    const column = parseInt(cell.dataset.column);
    
    console.log('Cell double-clicked:', { row, column, occupied: cell.classList.contains('occupied') });
    
    // 既に商品が配置されている場合は何もしない
    if (cell.classList.contains('occupied')) {
        return;
    }
    
    // モーダルのターゲット位置を設定
    document.getElementById('modalTargetRow').value = row;
    document.getElementById('modalTargetColumn').value = column;
    
    // モーダルを開く
    const modal = new bootstrap.Modal(document.getElementById('productSelectModal'));
    modal.show();
}

// モーダル内商品検索の設定
function setupModalProductSearch() {
    const searchInput = document.getElementById('modalProductSearch');
    const categoryFilter = document.getElementById('modalCategoryFilter');
    
    if (!searchInput || !categoryFilter) {
        console.warn('Modal search elements not found');
        return;
    }
    
    function filterModalProducts() {
        const searchQuery = searchInput.value.toLowerCase();
        const selectedCategory = categoryFilter.value;
        const products = document.querySelectorAll('.modal-product-item');
        
        products.forEach(product => {
            const searchText = product.dataset.searchText || '';
            const categoryId = product.dataset.categoryId || '';
            
            const matchesSearch = !searchQuery || searchText.includes(searchQuery);
            const matchesCategory = !selectedCategory || categoryId === selectedCategory;
            
            if (matchesSearch && matchesCategory) {
                product.style.display = 'block';
            } else {
                product.style.display = 'none';
            }
        });
    }
    
    searchInput.addEventListener('input', filterModalProducts);
    categoryFilter.addEventListener('change', filterModalProducts);
}

// モーダルから商品を選択
function selectProductFromModal(productElement) {
    const productData = {
        id: productElement.dataset.productId,
        name: productElement.dataset.productName,
        maker: productElement.dataset.makerName,
        isOwn: productElement.dataset.isOwn === 'true'
    };
    
    const row = parseInt(document.getElementById('modalTargetRow').value);
    const column = parseInt(document.getElementById('modalTargetColumn').value);
    
    console.log('Product selected from modal:', { productData, row, column });
    
    // モーダルを閉じる
    const modal = bootstrap.Modal.getInstance(document.getElementById('productSelectModal'));
    modal.hide();
    
    // 商品を配置
    placeProductOnShelf(productData, row, column);
}

// ドラッグ&ドロップ初期化（棚グリッドのみ）
function initializeDragAndDrop() {
    // 棚グリッドのSortable設定
    const shelfGridElement = document.getElementById('shelf-grid');
    
    if (!shelfGridElement) {
        console.warn('Shelf grid element not found');
        return;
    }
    
    new Sortable(shelfGridElement, {
        group: {
            name: 'products',
            pull: false,
            put: true
        },
        animation: 150,
        ghostClass: 'ghost-product',
        onAdd: function(evt) {
            console.log('Drop event triggered on shelf grid');
            
            // ドロップされた要素を削除（実際の配置はAPIで行う）
            evt.item.remove();
            
            // ドロップ先のセルを特定
            let targetCell = evt.to;
            
            // もしグリッド自体にドロップされた場合、最も近いセルを見つける
            if (targetCell.id === 'shelf-grid') {
                const cells = targetCell.querySelectorAll('.shelf-cell');
                
                if (!evt.originalEvent) {
                    console.error('Original event not found');
                    showToast('ドロップ位置を特定できません', 'error');
                    return;
                }
                
                const mousePos = { x: evt.originalEvent.clientX, y: evt.originalEvent.clientY };
                let closestCell = null;
                let minDistance = Infinity;
                
                cells.forEach(cell => {
                    const rect = cell.getBoundingClientRect();
                    const cellCenter = {
                        x: rect.left + rect.width / 2,
                        y: rect.top + rect.height / 2
                    };
                    const distance = Math.sqrt(
                        Math.pow(mousePos.x - cellCenter.x, 2) + 
                        Math.pow(mousePos.y - cellCenter.y, 2)
                    );
                    
                    if (distance < minDistance) {
                        minDistance = distance;
                        closestCell = cell;
                    }
                });
                
                targetCell = closestCell;
            }
            
            if (!targetCell || !targetCell.dataset) {
                console.error('Invalid target cell');
                showToast('無効なドロップ先です', 'error');
                return;
            }
            
            const row = parseInt(targetCell.dataset.row);
            const column = parseInt(targetCell.dataset.column);
            
            console.log('Target cell data:', { 
                row: targetCell.dataset.row, 
                column: targetCell.dataset.column,
                parsed: { row, column }
            });
            
            // 値の検証
            if (isNaN(row) || isNaN(column)) {
                console.error('Invalid row/column values:', { row, column });
                showToast('無効な配置位置です', 'error');
                return;
            }
            
            // セルが既に占有されているかチェック
            if (targetCell.classList.contains('occupied')) {
                showToast('この位置には既に商品が配置されています', 'error');
                return;
            }
            
            // 商品を配置
            if (draggedProduct) {
                placeProductOnShelf(draggedProduct, row, column);
            } else {
                console.error('No dragged product found');
                showToast('配置する商品が見つかりません', 'error');
            }
        }
    });
    
    console.log('Shelf grid drag and drop initialized');
    
    // 既存セルのドラッグ&ドロップも初期化
    initializeCellDragDrop();
}

// セル間コピー用のドラッグ&ドロップ初期化
function initializeCellDragDrop() {
    const occupiedCells = document.querySelectorAll('.shelf-cell.occupied');
    
    occupiedCells.forEach(cell => {
        // 既存のSortableがあれば破棄
        if (cell.sortable) {
            cell.sortable.destroy();
        }
        
        const sortable = new Sortable(cell, {
            group: {
                name: 'cell-products',
                pull: 'clone',
                put: false
            },
            sort: false,
            animation: 150,
            ghostClass: 'ghost-product',
            onStart: function(evt) {
                console.log('Cell drag started');
                
                const sourceCell = evt.from;
                const productId = sourceCell.dataset.productId;
                const placementId = sourceCell.dataset.placementId;
                
                if (!productId) {
                    console.error('No product ID found in source cell');
                    return;
                }
                
                // 商品データを取得（既存セルから）
                const productInfo = sourceCell.querySelector('.product-info');
                const productName = sourceCell.querySelector('.product-name');
                const isOwnProduct = sourceCell.classList.contains('own-product');
                
                draggedProduct = {
                    id: productId,
                    name: productName ? productName.textContent : 'Unknown Product',
                    maker: 'メーカー', // 実際のメーカー名は別途取得が必要
                    isOwn: isOwnProduct,
                    sourceCell: sourceCell,
                    isCopyMode: true  // コピーモードのフラグ
                };
                
                console.log('Dragged product from cell:', draggedProduct);
                
                // コピー用のドラッグプレビューを作成
                createCopyDragPreview(draggedProduct);
                
                // コピーモードを開始
                startCopyMode();
            },
            onEnd: function(evt) {
                console.log('Cell drag ended');
                // onEnd時は何もしない（セルクリック時にendCopyModeが呼ばれる）
            }
        });
        
        // Sortableインスタンスを保存
        cell.sortable = sortable;
    });
    
    console.log('Cell drag and drop initialized for', occupiedCells.length, 'cells');
}

// コピーモード開始
function startCopyMode() {
    console.log('Starting copy mode');
    
    // コピーモードを有効にする
    document.body.classList.add('copy-mode');
    
    // セルにコピー用ドロップゾーンのスタイルを追加
    document.querySelectorAll('.shelf-cell:not(.occupied)').forEach(cell => {
        cell.classList.add('copy-drop-zone-active');
    });
    
    // ヘルプメッセージを切り替え
    const helpText = document.getElementById('helpText');
    const copyModeHelp = document.getElementById('copyModeHelp');
    if (helpText) helpText.style.display = 'none';
    if (copyModeHelp) copyModeHelp.style.display = 'block';
}

// コピーモード終了
function endCopyMode() {
    console.log('Ending copy mode');
    
    // コピーモードを無効にする
    document.body.classList.remove('copy-mode');
    
    // ドロップゾーンのスタイルを削除
    document.querySelectorAll('.shelf-cell').forEach(cell => {
        cell.classList.remove('copy-drop-zone-active');
    });
    
    // ドラッグプレビューを非表示
    hideDragPreview();
    
    // ヘルプメッセージを元に戻す
    const helpText = document.getElementById('helpText');
    const copyModeHelp = document.getElementById('copyModeHelp');
    if (helpText) helpText.style.display = 'block';
    if (copyModeHelp) copyModeHelp.style.display = 'none';
    
    // draggedProductをリセット
    draggedProduct = null;
}

// コピー用ドラッグプレビュー作成
function createCopyDragPreview(product) {
    const preview = document.getElementById('dragPreview');
    preview.innerHTML = `
        <div class="d-flex align-items-center">
            <div class="me-2 bg-success d-flex align-items-center justify-content-center" 
                 style="width: 30px; height: 30px; border-radius: 4px;">
                <i class="bi bi-copy text-white"></i>
            </div>
            <div>
                <div class="fw-bold" style="font-size: 0.8rem;">${product.name}</div>
                <small class="text-success">コピー中...</small>
            </div>
        </div>
        <div class="text-center mt-1">
            <small class="text-success">空いているセルをクリック</small>
        </div>
    `;
    preview.style.display = 'block';
    preview.style.borderColor = '#198754';
    
    // マウス追従
    document.addEventListener('mousemove', updateDragPreview);
}

// ドラッグプレビュー作成
function createDragPreview(product) {
    const preview = document.getElementById('dragPreview');
    preview.innerHTML = `
        <div class="d-flex align-items-center">
            <div class="me-2 bg-light d-flex align-items-center justify-content-center" 
                 style="width: 30px; height: 30px; border-radius: 4px;">
                <i class="bi bi-image text-muted"></i>
            </div>
            <div>
                <div class="fw-bold" style="font-size: 0.8rem;">${product.name}</div>
                <small class="text-muted">${product.maker}</small>
            </div>
        </div>
    `;
    preview.style.display = 'block';
    
    // マウス追従
    document.addEventListener('mousemove', updateDragPreview);
}

// ドラッグプレビュー更新
function updateDragPreview(e) {
    const preview = document.getElementById('dragPreview');
    preview.style.left = (e.clientX + 10) + 'px';
    preview.style.top = (e.clientY + 10) + 'px';
}

// ドラッグプレビュー非表示
function hideDragPreview() {
    document.getElementById('dragPreview').style.display = 'none';
    document.removeEventListener('mousemove', updateDragPreview);
}

// 商品を棚に配置
function placeProductOnShelf(product, row, column) {
    // 入力値の検証
    if (!product || !product.id) {
        showToast('商品データが無効です', 'error');
        console.error('Invalid product data:', product);
        return;
    }
    
    if (typeof row !== 'number' || typeof column !== 'number' || isNaN(row) || isNaN(column)) {
        showToast('無効な配置位置です', 'error');
        console.error('Invalid position:', { row, column, product });
        return;
    }
    
    if (row < 0 || column < 0) {
        showToast('配置位置が無効です', 'error');
        console.error('Negative position:', { row, column });
        return;
    }
    
    // 対象セルの存在確認
    const targetCell = document.querySelector(`[data-row="${row}"][data-column="${column}"]`);
    if (!targetCell) {
        showToast('対象のセルが見つかりません', 'error');
        console.error('Target cell not found:', { row, column });
        return;
    }
    
    // セルが既に占有されているかチェック
    if (targetCell.classList.contains('occupied')) {
        showToast('この位置には既に商品が配置されています', 'error');
        console.warn('Cell already occupied:', { row, column });
        return;
    }
    
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    formData.append('shelf_id', {{ shelf.id }});
    formData.append('product_id', product.id);
    formData.append('row', row.toString());
    formData.append('column', column.toString());
    formData.append('face_count', '1');
    formData.append('span_rows', '1');
    formData.append('span_columns', '1');
    
    console.log('Placing product:', { 
        product_id: product.id,
        product_name: product.name,
        row, 
        column, 
        shelf_id: {{ shelf.id }} 
    });
    
    // UIを一時的に無効化
    targetCell.style.opacity = '0.5';
    targetCell.style.pointerEvents = 'none';
    
    fetch('{% url "shelves:place_product" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log('API response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('API Response:', data);
        
        // UIを元に戻す
        targetCell.style.opacity = '';
        targetCell.style.pointerEvents = '';
        
        if (data.success) {
            // アクション履歴に追加
            actionHistory.push({
                type: 'place',
                data: { product: product, row: row, column: column }
            });
            
            // セルを更新
            updateCellDisplay(row, column, data.placement);
            updateStats();
            
            // 成功フィードバック
            showToast(`${product.name} を配置しました`, 'success');
        } else {
            showToast('エラー: ' + data.error, 'error');
            console.error('Placement error:', data.error);
        }
    })
    .catch(error => {
        // UIを元に戻す
        targetCell.style.opacity = '';
        targetCell.style.pointerEvents = '';
        
        showToast('ネットワークエラーが発生しました', 'error');
        console.error('Network error:', error);
    });
}

// セル表示更新
function updateCellDisplay(row, column, placement) {
    const cell = document.querySelector(`[data-row="${row}"][data-column="${column}"]`);
    if (!cell) {
        console.error('Cell not found:', { row, column });
        return;
    }
    
    cell.classList.add('occupied');
    cell.classList.add(placement.is_own_product ? 'own-product' : 'competitor-product');
    cell.dataset.placementId = placement.id;
    cell.dataset.productId = placement.product_id;
    
    const imageHtml = placement.image_url 
        ? `<img src="${placement.image_url}" alt="${placement.product_name}" class="product-image">`
        : `<div class="no-image-placeholder"><i class="bi bi-image" style="font-size: 2rem; color: #dee2e6;"></i></div>`;
    
    cell.innerHTML = `
        <div class="product-info">
            ${imageHtml}
            <div class="product-name">${placement.product_name.substring(0, 15)}</div>
        </div>
        ${placement.face_count > 1 ? `<div class="face-count editable" onclick="editFaceCount(${placement.id}, ${placement.face_count})">${placement.face_count}</div>` : ''}
    `;
    
    // ダブルクリックイベントを再設定
    cell.setAttribute('ondblclick', 'handleCellDoubleClick(this)');
}

// 統計更新
function updateStats() {
    const occupiedCells = document.querySelectorAll('.shelf-cell.occupied');
    const ownProducts = document.querySelectorAll('.shelf-cell.own-product');
    const competitorProducts = document.querySelectorAll('.shelf-cell.competitor-product');
    const totalCells = {{ shelf.rows }} * {{ shelf.columns }};
    
    const occupiedCount = occupiedCells.length;
    const ownCount = ownProducts.length;
    const competitorCount = competitorProducts.length;
    const occupancyRate = totalCells > 0 ? Math.round((occupiedCount / totalCells) * 100) : 0;
    
    // DOM要素が存在するかチェックしてから更新
    const totalElement = document.getElementById('totalProducts');
    const ownElement = document.getElementById('ownProducts');
    const competitorElement = document.getElementById('competitorProducts');
    const occupancyElement = document.getElementById('occupancyRate');
    
    if (totalElement) totalElement.textContent = occupiedCount;
    if (ownElement) ownElement.textContent = ownCount;
    if (competitorElement) competitorElement.textContent = competitorCount;
    if (occupancyElement) occupancyElement.textContent = occupancyRate + '%';
    
    console.log('Stats updated:', {
        total: occupiedCount,
        own: ownCount,
        competitor: competitorCount,
        occupancy: occupancyRate + '%'
    });
}

// 商品検索
function setupProductSearch() {
    const searchInput = document.getElementById('productSearch');
    
    if (!searchInput) {
        console.warn('Product search input not found');
        return;
    }
    
    searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase();
        const products = document.querySelectorAll('.product-item');
        
        console.log('Searching products:', query, 'Found items:', products.length);
        
        products.forEach(product => {
            const searchText = product.dataset.searchText || '';
            if (!query || searchText.includes(query)) {
                product.style.display = 'block';
            } else {
                product.style.display = 'none';
            }
        });
    });
}

// 検索クリア
function clearSearch() {
    const searchInput = document.getElementById('productSearch');
    if (searchInput) {
        searchInput.value = '';
        document.querySelectorAll('.product-item').forEach(product => {
            product.style.display = 'block';
        });
    }
}

// デバッグ用: ドラッグ&ドロップの状態を確認
function debugDragDrop() {
    console.log('=== Drag & Drop Debug Info ===');
    console.log('Dragged product:', draggedProduct);
    console.log('Product list element:', document.getElementById('productList'));
    console.log('Shelf grid element:', document.getElementById('shelf-grid'));
    console.log('Product items count:', document.querySelectorAll('.product-item').length);
    
    // 商品アイテムのデータをチェック
    const firstProduct = document.querySelector('.product-item');
    if (firstProduct) {
        console.log('First product data:', {
            id: firstProduct.dataset.productId,
            name: firstProduct.dataset.productName,
            maker: firstProduct.dataset.makerName,
            isOwn: firstProduct.dataset.isOwn
        });
    }
}

// ウィンドウにデバッグ関数を追加（開発用）
window.debugDragDrop = debugDragDrop;

// キーボードショートカット
function setupKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 'z':
                    e.preventDefault();
                    undoLastAction();
                    break;
                case 's':
                    e.preventDefault();
                    saveShelfLayout();
                    break;
            }
        }
        
        if (e.key === 'Delete' && selectedCell) {
            removeProductFromCell(selectedCell);
        }
    });
}

// ズーム機能
function zoomIn() {
    currentZoom = Math.min(currentZoom * 1.2, 3);
    applyZoom();
}

function zoomOut() {
    currentZoom = Math.max(currentZoom / 1.2, 0.5);
    applyZoom();
}

function resetZoom() {
    currentZoom = 1;
    applyZoom();
}

function applyZoom() {
    const shelfGrid = document.getElementById('shelf-grid');
    shelfGrid.style.transform = `scale(${currentZoom})`;
    shelfGrid.style.transformOrigin = 'center';
}

// 座標表示切り替え
function toggleCoordinates() {
    const coordinates = document.getElementById('shelfCoordinates');
    const rowLabels = document.getElementById('shelfRowLabels');
    const isVisible = coordinates.style.display !== 'none';
    
    coordinates.style.display = isVisible ? 'none' : 'flex';
    rowLabels.style.display = isVisible ? 'none' : 'flex';
}

// グリッド表示切り替え
function toggleGrid() {
    const cells = document.querySelectorAll('.shelf-cell');
    cells.forEach(cell => {
        if (cell.style.border === 'none') {
            cell.style.border = '1px solid #dee2e6';
        } else {
            cell.style.border = 'none';
        }
    });
}

// フェース数編集
function editFaceCount(placementId, currentCount) {
    const newCount = prompt('フェース数を入力してください:', currentCount);
    if (newCount && newCount !== currentCount.toString()) {
        updateFaceCount(placementId, parseInt(newCount));
    }
}

// フェース数更新
function updateFaceCount(placementId, faceCount) {
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    formData.append('placement_id', placementId);
    formData.append('face_count', faceCount);
    
    fetch('{% url "shelves:update_face_count" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // 簡単のためリロード
        } else {
            showToast('エラー: ' + data.error, 'error');
        }
    });
}

// トースト通知
function showToast(message, type = 'info') {
    // Bootstrap Toast実装（簡略化）
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} position-fixed`;
    toast.style.top = '20px';
    toast.style.right = '20px';
    toast.style.zIndex = '9999';
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// 元に戻す
function undoLastAction() {
    if (actionHistory.length > 0) {
        const lastAction = actionHistory.pop();
        // 実装は簡略化
        showToast('元に戻しました', 'info');
    }
}

// 棚レイアウト保存
function saveShelfLayout() {
    showToast('レイアウトを保存しました', 'success');
}

// 全削除
function clearShelf() {
    if (confirm('すべての商品を削除しますか？')) {
        // 実装は簡略化
        showToast('すべての商品を削除しました', 'info');
    }
}

// 自動配置
function autoArrange() {
    showToast('自動配置機能は開発中です', 'info');
}

// 商品情報編集
function editProduct() {
    // 実装は簡略化
    showToast('商品情報を編集しました', 'info');
}

// 商品複製
function duplicateProduct() {
    // 実装は簡略化
    showToast('商品を複製しました', 'info');
}

// 商品移動
function moveProduct() {
    // 実装は簡略化
    showToast('商品を移動しました', 'info');
}

// 商品削除
function removeProduct() {
    // 実装は簡略化
    showToast('商品を削除しました', 'info');
}

// 商品削除
function removeProductFromCell(cell) {
    const placementId = cell.dataset.placementId;
    if (!placementId) {
        showToast('削除する商品が見つかりません', 'error');
        return;
    }
    
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    formData.append('placement_id', placementId);
    
    fetch('{% url "shelves:remove_product" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // セルを空の状態に戻す
            cell.classList.remove('occupied');
            cell.classList.remove('own-product');
            cell.classList.remove('competitor-product');
            cell.dataset.placementId = '';
            cell.dataset.productId = '';
            
            // 空のセルの表示に戻す
            cell.innerHTML = `
                <div class="empty-cell-hint">
                    <i class="bi bi-plus-circle"></i><br>
                    ダブルクリックで<br>商品を選択
                </div>
            `;
            
            updateStats();
            showToast('商品を削除しました', 'success');
        } else {
            showToast('エラー: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showToast('ネットワークエラーが発生しました', 'error');
        console.error('Network error:', error);
    });
}

// 商品配置確定
function confirmPlacement() {
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    formData.append('shelf_id', document.getElementById('modalShelfId').value);
    formData.append('product_id', document.getElementById('modalProductId').value);
    formData.append('row', document.getElementById('modalRow').value);
    formData.append('column', document.getElementById('modalColumn').value);
    formData.append('face_count', document.getElementById('modalFaceCount').value);
    formData.append('span_rows', document.getElementById('modalSpanRows').value);
    formData.append('span_columns', document.getElementById('modalSpanColumns').value);
    
    fetch('{% url "shelves:place_product" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // 簡単のためページをリロード
        } else {
            alert('エラー: ' + data.error);
        }
    })
    .catch(error => {
        alert('エラーが発生しました: ' + error);
    });
}

// 商品削除確定
function confirmRemoval() {
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    formData.append('placement_id', document.getElementById('removePlacementId').value);
    
    fetch('{% url "shelves:remove_product" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // 簡単のためページをリロード
        } else {
            alert('エラー: ' + data.error);
        }
    })
    .catch(error => {
        alert('エラーが発生しました: ' + error);
    });
}
</script>
{% endblock %}