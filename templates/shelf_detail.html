{% extends 'base.html' %}
{% load range_filter %}

{% block title %}{{ shelf.name }} - サイズベース棚割り編集{% endblock %}

{% block extra_css %}
<style>
/* 棚コンテナ */
.shelf-container {
    background-color: #f8f9fa;
    border: 2px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    margin: 1rem 0;
    position: relative;
    width: 100%;
    overflow: hidden;
}

/* サイズベースグリッド */
.size-aware-grid {
    display: grid;
    gap: 1px;
    width: 100%;
    position: relative;
    background-color: #ffffff;
    border: 1px solid #dee2e6;
}

/* セル基本スタイル */
.grid-cell {
    border: 1px solid #e9ecef;
    background-color: #ffffff;
    position: relative;
    min-height: 40px;
    transition: all 0.2s ease;
}

/* 空のセル */
.grid-cell.empty {
    cursor: pointer;
    background-color: #ffffff;
}

.grid-cell.empty:hover {
    background-color: #e7f1ff;
    border-color: #0d6efd;
}

/* 商品配置エリア */
.product-placement {
    position: absolute;
    top: 0;
    left: 0;
    border: 2px solid #dee2e6;
    border-radius: 4px;
    background-color: #f8f9fa;
    cursor: grab;
    transition: all 0.2s ease;
    z-index: 10;
    overflow: hidden;
}

.product-placement:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    z-index: 20;
}

.product-placement.own-product {
    background-color: #d4edda;
    border-color: #c3e6cb;
}

.product-placement.competitor-product {
    background-color: #fff3cd;
    border-color: #ffeaa7;
}

/* 商品情報表示 */
.product-content {
    padding: 4px;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    position: relative;
}

.product-image {
    max-width: 90%;
    max-height: 70%;
    object-fit: contain;
    border-radius: 2px;
}

.product-name {
    font-size: 0.7rem;
    font-weight: bold;
    text-align: center;
    margin-top: 2px;
    line-height: 1.1;
    color: #495057;
    text-overflow: ellipsis;
    overflow: hidden;
    white-space: nowrap;
    width: 100%;
}

.product-maker {
    font-size: 0.6rem;
    color: #6c757d;
    text-align: center;
}

/* フェース数バッジ */
.face-count-badge {
    position: absolute;
    top: 2px;
    right: 2px;
    background-color: #0d6efd;
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    font-size: 0.7rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    cursor: pointer;
    z-index: 30;
}

.face-count-badge:hover {
    background-color: #0056b3;
    transform: scale(1.1);
}

/* サイズインジケーター */
.size-indicator {
    position: absolute;
    bottom: 2px;
    left: 2px;
    padding: 1px 4px;
    font-size: 0.6rem;
    border-radius: 2px;
    color: white;
    font-weight: bold;
}

.size-indicator.small {
    background-color: #28a745;
}

.size-indicator.medium {
    background-color: #ffc107;
    color: #212529;
}

.size-indicator.large {
    background-color: #dc3545;
}

.size-indicator.oversized {
    background-color: #6f42c1;
}

/* ドラッグ&ドロップフィードバック */
.drag-preview-large {
    position: fixed;
    pointer-events: none;
    z-index: 9999;
    background: white;
    border: 2px dashed #0d6efd;
    border-radius: 8px;
    padding: 8px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    opacity: 0.9;
}

.drop-zone-valid {
    background-color: rgba(40, 167, 69, 0.2) !important;
    border-color: #28a745 !important;
}

.drop-zone-invalid {
    background-color: rgba(220, 53, 69, 0.2) !important;
    border-color: #dc3545 !important;
}

.drop-zone-warning {
    background-color: rgba(255, 193, 7, 0.2) !important;
    border-color: #ffc107 !important;
}

/* サイズプレビュー */
.size-preview-overlay {
    position: absolute;
    border: 2px dashed #007bff;
    background-color: rgba(0, 123, 255, 0.1);
    z-index: 15;
    pointer-events: none;
}

/* 商品リスト（サイズ情報付き） */
.product-item-with-size {
    position: relative;
    cursor: grab;
    transition: all 0.2s;
    border-radius: 4px;
    padding: 8px;
    margin-bottom: 8px;
}

.product-item-with-size:hover {
    background-color: #f8f9fa;
    transform: translateX(5px);
}

.product-size-info {
    font-size: 0.7rem;
    color: #6c757d;
    margin-top: 4px;
}

.required-cells-badge {
    display: inline-block;
    padding: 2px 6px;
    font-size: 0.6rem;
    border-radius: 10px;
    font-weight: bold;
    margin-right: 4px;
}

.required-cells-badge.small {
    background-color: #d1ecf1;
    color: #0c5460;
}

.required-cells-badge.medium {
    background-color: #fff3cd;
    color: #856404;
}

.required-cells-badge.large {
    background-color: #f8d7da;
    color: #721c24;
}

/* 統計パネル拡張 */
.size-stats {
    background: #f8f9fa;
    border-radius: 0.375rem;
    padding: 1rem;
    margin-bottom: 1rem;
}

.size-breakdown {
    display: flex;
    gap: 1rem;
    margin-top: 0.5rem;
}

.size-category {
    flex: 1;
    text-align: center;
    padding: 0.5rem;
    border-radius: 0.25rem;
    border: 1px solid #dee2e6;
}

/* レスポンシブ調整 */
@media (max-width: 768px) {
    .shelf-container {
        padding: 0.5rem;
    }
    
    .product-placement {
        border-width: 1px;
    }
    
    .product-name {
        font-size: 0.6rem;
    }
}

/* アニメーション */
@keyframes placement-success {
    0% { transform: scale(1.2); opacity: 0.8; }
    100% { transform: scale(1); opacity: 1; }
}

.placement-success {
    animation: placement-success 0.3s ease-out;
}

/* ツールチップ */
.size-tooltip {
    position: absolute;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.7rem;
    z-index: 1000;
    white-space: nowrap;
    pointer-events: none;
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1>{{ shelf.name }} <small class="text-muted">(サイズベース)</small></h1>
        <p class="text-muted mb-0">
            {{ shelf.width }}×{{ shelf.height }}×{{ shelf.depth }}cm | 
            {{ shelf.rows }}段×{{ shelf.columns }}列 |
            セル: {{ shelf_info.cell_width|floatformat:1 }}×{{ shelf_info.cell_height|floatformat:1 }}cm
        </p>
    </div>
    <div class="btn-group">
        <button class="btn btn-outline-primary" onclick="saveShelfLayout()">
            <i class="bi bi-save"></i> 保存
        </button>
        <button class="btn btn-outline-secondary" onclick="optimizeLayout()">
            <i class="bi bi-magic"></i> 最適化
        </button>
        <button class="btn btn-outline-secondary" onclick="toggleProductPanel()">
            <i class="bi bi-list"></i> 商品一覧
        </button>
        <a href="{% url 'shelves:shelf_list' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> 棚一覧
        </a>
    </div>
</div>

<!-- CSRFトークン -->
<form style="display: none;">
    {% csrf_token %}
</form>

<!-- 拡張統計パネル -->
<div class="size-stats">
    <div class="row">
        <div class="col-md-2">
            <div class="text-center">
                <div class="h4 text-primary" id="totalProducts">{{ placements|length }}</div>
                <small class="text-muted">配置商品</small>
            </div>
        </div>
        <div class="col-md-2">
            <div class="text-center">
                <div class="h4 text-success" id="ownProducts">0</div>
                <small class="text-muted">自社商品</small>
            </div>
        </div>
        <div class="col-md-2">
            <div class="text-center">
                <div class="h4 text-info" id="occupancyRate">0%</div>
                <small class="text-muted">セル占有率</small>
            </div>
        </div>
        <div class="col-md-2">
            <div class="text-center">
                <div class="h4 text-warning" id="areaUtilization">0%</div>
                <small class="text-muted">面積利用率</small>
            </div>
        </div>
        <div class="col-md-4">
            <small class="text-muted">サイズ分布</small>
            <div class="size-breakdown">
                <div class="size-category">
                    <div class="fw-bold text-success" id="smallProducts">0</div>
                    <small>小</small>
                </div>
                <div class="size-category">
                    <div class="fw-bold text-warning" id="mediumProducts">0</div>
                    <small>中</small>
                </div>
                <div class="size-category">
                    <div class="fw-bold text-danger" id="largeProducts">0</div>
                    <small>大</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 棚割りエリア -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">棚割りレイアウト（サイズベース）</h5>
        <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-secondary" onclick="toggleSizeIndicators()">
                <i class="bi bi-rulers"></i> サイズ表示
            </button>
            <button class="btn btn-outline-secondary" onclick="toggleGridLines()">
                <i class="bi bi-grid"></i> グリッド
            </button>
            <button class="btn btn-outline-secondary" onclick="resetView()">
                <i class="bi bi-arrows-fullscreen"></i> リセット
            </button>
        </div>
    </div>
    <div class="card-body p-2">
        <div class="shelf-container" id="shelfContainer">
            <!-- サイズベースグリッド -->
            <div class="size-aware-grid" id="sizeAwareGrid" 
                 style="grid-template-rows: repeat({{ shelf.rows }}, {{ shelf_info.cell_height|mul:2 }}px); 
                        grid-template-columns: repeat({{ shelf.columns }}, {{ shelf_info.cell_width|mul:2 }}px);">
                
                <!-- 空のセルを生成 -->
                {% for row in shelf.rows|range %}
                    {% for col in shelf.columns|range %}
                        <div class="grid-cell empty" 
                             data-row="{{ row }}" 
                             data-column="{{ col }}"
                             onclick="handleCellClick(this, {{ row }}, {{ col }})"
                             ondrop="handleDrop(event, {{ row }}, {{ col }})"
                             ondragover="handleDragOver(event, {{ row }}, {{ col }})"
                             ondragleave="handleDragLeave(event)">
                        </div>
                    {% endfor %}
                {% endfor %}
                
                <!-- 配置された商品 -->
                {% for placement in placements %}
                    <div class="product-placement {% if placement.product.is_own_product %}own-product{% else %}competitor-product{% endif %}" 
                         data-placement-id="{{ placement.id }}"
                         data-product-id="{{ placement.product.id }}"
                         data-row="{{ placement.row }}"
                         data-column="{{ placement.column }}"
                         data-span-rows="{{ placement.span_rows }}"
                         data-span-columns="{{ placement.span_columns }}"
                         style="grid-row: {{ placement.row|add:1 }} / {{ placement.row|add:placement.span_rows|add:1 }};
                                grid-column: {{ placement.column|add:1 }} / {{ placement.column|add:placement.span_columns|add:1 }};
                                width: {{ placement.display_width_ratio|mul:100 }}%;
                                height: {{ placement.display_height_ratio|mul:100 }}%;"
                         draggable="true"
                         ondragstart="handleProductDragStart(event, this)"
                         onclick="selectPlacement(this)"
                         oncontextmenu="showPlacementContextMenu(event, this)">
                        
                        <div class="product-content">
                            {% if placement.product.image %}
                                <img src="{{ placement.product.image.url }}" 
                                     alt="{{ placement.product.product_name }}" 
                                     class="product-image">
                            {% else %}
                                <div class="text-center text-muted">
                                    <i class="bi bi-image" style="font-size: 1.5rem;"></i>
                                </div>
                            {% endif %}
                            
                            <div class="product-name">{{ placement.product.product_name|truncatechars:20 }}</div>
                            <div class="product-maker">{{ placement.product.maker.name|truncatechars:15 }}</div>
                        </div>
                        
                        <!-- フェース数バッジ -->
                        {% if placement.face_count > 1 %}
                            <div class="face-count-badge" 
                                 onclick="editFaceCount({{ placement.id }}, {{ placement.face_count }}); event.stopPropagation();">
                                {{ placement.face_count }}
                            </div>
                        {% endif %}
                        
                        <!-- サイズインジケーター -->
                        <div class="size-indicator {% if placement.span_rows == 1 and placement.span_columns == 1 %}small{% elif placement.span_rows <= 2 and placement.span_columns <= 2 %}medium{% else %}large{% endif %}"
                             title="占有: {{ placement.span_rows }}×{{ placement.span_columns }}セル">
                            {{ placement.span_rows }}×{{ placement.span_columns }}
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- ヘルプテキスト -->
        <div class="mt-2 d-flex justify-content-between align-items-center">
            <div>
                <small class="text-muted">
                    <span class="badge" style="background-color: #d4edda; color: #155724;">自社商品</span>
                    <span class="badge" style="background-color: #fff3cd; color: #856404;">競合商品</span>
                    <span class="badge bg-secondary">サイズ: 段×列</span>
                </small>
            </div>
            <div>
                <small class="text-muted" id="currentAction">
                    商品をドラッグ&ドロップして配置 | セルクリックで商品選択
                </small>
            </div>
        </div>
    </div>
</div>

<!-- サイズプレビューオーバーレイ -->
<div class="size-preview-overlay" id="sizePreview" style="display: none;"></div>

<!-- 商品選択モーダル（サイズ情報付き） -->
<div class="modal fade" id="productSizeModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">商品を選択（サイズ考慮）</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="row">
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="modalSizeProductSearch" placeholder="商品名、メーカー名で検索...">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="modalSizeCategoryFilter">
                                <option value="">すべてのカテゴリ</option>
                                {% for category in categories %}
                                    <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="modalSizeFilter">
                                <option value="">すべてのサイズ</option>
                                <option value="small">小サイズ（1セル）</option>
                                <option value="medium">中サイズ（2-4セル）</option>
                                <option value="large">大サイズ（5+セル）</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="row" id="modalSizeProductList" style="max-height: 400px; overflow-y: auto;">
                    {% for item in products_with_size %}
                        <div class="col-md-6 col-lg-3 mb-3 modal-product-item" 
                             data-product-id="{{ item.product.id }}"
                             data-product-name="{{ item.product.product_name }}"
                             data-category-id="{{ item.product.category.id }}"
                             data-size-category="{{ item.size_category }}"
                             data-required-rows="{{ item.required_cells.span_rows }}"
                             data-required-columns="{{ item.required_cells.span_columns }}"
                             onclick="selectSizeProduct(this)">
                            <div class="card h-100 product-card">
                                <div class="card-body p-2">
                                    {% if item.product.image %}
                                        <img src="{{ item.product.image.url }}" 
                                             alt="{{ item.product.product_name }}" 
                                             class="img-fluid mb-2" 
                                             style="height: 80px; object-fit: contain; width: 100%;">
                                    {% else %}
                                        <div class="bg-light d-flex align-items-center justify-content-center mb-2" 
                                             style="height: 80px;">
                                            <i class="bi bi-image text-muted" style="font-size: 2rem;"></i>
                                        </div>
                                    {% endif %}
                                    
                                    <h6 class="card-title mb-1" style="font-size: 0.8rem;">
                                        {{ item.product.product_name|truncatechars:25 }}
                                    </h6>
                                    <small class="text-muted d-block mb-2">{{ item.product.maker.name }}</small>
                                    
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        {% if item.product.is_own_product %}
                                            <span class="badge bg-success">自社</span>
                                        {% else %}
                                            <span class="badge bg-warning">競合</span>
                                        {% endif %}
                                        
                                        <span class="required-cells-badge {{ item.size_category }}">
                                            {{ item.required_cells.span_rows }}×{{ item.required_cells.span_columns }}
                                        </span>
                                    </div>
                                    
                                    {% if item.product.width and item.product.height %}
                                        <div class="product-size-info">
                                            サイズ: {{ item.product.width|floatformat:1 }}×{{ item.product.height|floatformat:1 }}cm
                                        </div>
                                    {% else %}
                                        <div class="product-size-info text-muted">
                                            サイズ未設定
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <input type="hidden" id="modalTargetRow">
                <input type="hidden" id="modalTargetColumn">
            </div>
            <div class="modal-footer">
                <div class="text-muted me-auto">
                    <small>選択位置: <span id="targetPositionDisplay">-</span></small>
                </div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
            </div>
        </div>
    </div>
</div>

<!-- サイズツールチップ -->
<div class="size-tooltip" id="sizeTooltip" style="display: none;"></div>
{% endblock %}

{% block extra_js %}
<script>
// グローバル変数
let draggedProduct = null;
let selectedPlacement = null;
let currentPreview = null;
let shelfInfo = {
    id: {{ shelf.id }},
    rows: {{ shelf.rows }},
    columns: {{ shelf.columns }},
    cellWidth: {{ shelf_info.cell_width }},
    cellHeight: {{ shelf_info.cell_height }},
};

// 初期化
document.addEventListener('DOMContentLoaded', function() {
    initializeSizeAwareDragDrop();
    updateStats();
    setupSizeModalSearch();
    console.log('Size-aware shelf system initialized');
});

// セルクリックハンドラー
function handleCellClick(cell, row, column) {
    if (draggedProduct) {
        // ドラッグ中の商品を配置
        placeProductWithSize(draggedProduct, row, column);
        clearDragState();
    } else {
        // 商品選択モーダルを開く
        showProductSelectionModal(row, column);
    }
}

// 商品選択モーダル表示
function showProductSelectionModal(row, column) {
    document.getElementById('modalTargetRow').value = row;
    document.getElementById('modalTargetColumn').value = column;
    document.getElementById('targetPositionDisplay').textContent = `${row + 1}段${column + 1}列`;
    
    const modal = new bootstrap.Modal(document.getElementById('productSizeModal'));
    modal.show();
}

// サイズ考慮商品選択
function selectSizeProduct(element) {
    const productData = {
        id: element.dataset.productId,
        name: element.dataset.productName,
        requiredRows: parseInt(element.dataset.requiredRows),
        requiredColumns: parseInt(element.dataset.requiredColumns),
    };
    
    const row = parseInt(document.getElementById('modalTargetRow').value);
    const column = parseInt(document.getElementById('modalTargetColumn').value);
    
    // モーダルを閉じる
    const modal = bootstrap.Modal.getInstance(document.getElementById('productSizeModal'));
    modal.hide();
    
    // 配置可能性をチェックしてから配置
    checkPlacementPossibility(productData, row, column)
        .then(result => {
            if (result.can_place) {
                placeProductWithSize(productData, row, column);
            } else {
                showToast('この位置には配置できません: ' + result.reason, 'error');
            }
        });
}

// サイズ考慮配置
function placeProductWithSize(product, row, column) {
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    formData.append('shelf_id', shelfInfo.id);
    formData.append('product_id', product.id);
    formData.append('row', row);
    formData.append('column', column);
    formData.append('face_count', 1);
    
    // UIフィードバック
    showLoadingIndicator(row, column);
    
    fetch('/shelves/api/place-product-with-size/', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        hideLoadingIndicator();
        
        if (data.success) {
            // 成功時の処理
            addPlacementToGrid(data.placement);
            updateStats();
            showToast(`${product.name} を配置しました`, 'success');
        } else {
            showToast('エラー: ' + data.error, 'error');
        }
    })
    .catch(error => {
        hideLoadingIndicator();
        showToast('ネットワークエラーが発生しました', 'error');
        console.error('Placement error:', error);
    });
}

// 配置可能性チェック
function checkPlacementPossibility(product, row, column) {
    const params = new URLSearchParams({
        shelf_id: shelfInfo.id,
        product_id: product.id,
        row: row,
        column: column,
        face_count: 1
    });
    
    return fetch(`/shelves/api/check-placement-possibility/?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                return { can_place: false, reason: data.error };
            }
            
            if (!data.can_place) {
                let reason = '配置できません';
                if (data.exceeds_boundary) {
                    reason = '棚の範囲を超えます';
                } else {
                    reason = '他の商品と重複します';
                }
                return { can_place: false, reason: reason };
            }
            
            return { can_place: true, data: data };
        })
        .catch(error => {
            console.error('Check placement error:', error);
            return { can_place: false, reason: 'チェックエラー' };
        });
}

// グリッドに配置を追加
function addPlacementToGrid(placement) {
    const grid = document.getElementById('sizeAwareGrid');
    
    // 既存の配置要素があれば削除
    const existing = grid.querySelector(`[data-placement-id="${placement.id}"]`);
    if (existing) {
        existing.remove();
    }
    
    // 新しい配置要素を作成
    const placementElement = document.createElement('div');
    placementElement.className = `product-placement ${placement.is_own_product ? 'own-product' : 'competitor-product'} placement-success`;
    placementElement.dataset.placementId = placement.id;
    placementElement.dataset.productId = placement.product_id;
    placementElement.dataset.row = placement.row || 0;
    placementElement.dataset.column = placement.column || 0;
    placementElement.dataset.spanRows = placement.span_rows || 1;
    placementElement.dataset.spanColumns = placement.span_columns || 1;
    
    // CSS Grid配置スタイル
    const row = parseInt(placement.row || 0);
    const column = parseInt(placement.column || 0);
    const spanRows = parseInt(placement.span_rows || 1);
    const spanColumns = parseInt(placement.span_columns || 1);
    
    placementElement.style.gridRow = `${row + 1} / ${row + spanRows + 1}`;
    placementElement.style.gridColumn = `${column + 1} / ${column + spanColumns + 1}`;
    placementElement.style.width = `${(placement.display_width_ratio || 1) * 100}%`;
    placementElement.style.height = `${(placement.display_height_ratio || 1) * 100}%`;
    
    // 商品情報HTML
    const imageHtml = placement.image_url 
        ? `<img src="${placement.image_url}" alt="${placement.product_name}" class="product-image">`
        : `<div class="text-center text-muted"><i class="bi bi-image" style="font-size: 1.5rem;"></i></div>`;
    
    const faceCountBadge = placement.face_count > 1 
        ? `<div class="face-count-badge" onclick="editFaceCount(${placement.id}, ${placement.face_count}); event.stopPropagation();">${placement.face_count}</div>`
        : '';
    
    const sizeClass = (spanRows === 1 && spanColumns === 1) ? 'small' : 
                     (spanRows <= 2 && spanColumns <= 2) ? 'medium' : 'large';
    
    placementElement.innerHTML = `
        <div class="product-content">
            ${imageHtml}
            <div class="product-name">${placement.product_name.substring(0, 20)}</div>
            <div class="product-maker">${placement.maker_name.substring(0, 15)}</div>
        </div>
        ${faceCountBadge}
        <div class="size-indicator ${sizeClass}" title="占有: ${spanRows}×${spanColumns}セル">
            ${spanRows}×${spanColumns}
        </div>
    `;
    
    // イベントリスナー設定
    placementElement.draggable = true;
    placementElement.onclick = () => selectPlacement(placementElement);
    placementElement.oncontextmenu = (e) => showPlacementContextMenu(e, placementElement);
    placementElement.ondragstart = (e) => handleProductDragStart(e, placementElement);
    
    grid.appendChild(placementElement);
}

// 統計更新（サイズ考慮）
function updateStats() {
    fetch(`/shelves/api/stats/${shelfInfo.id}/`)
        .then(response => response.json())
        .then(stats => {
            // 基本統計
            updateElement('totalProducts', stats.total_products || 0);
            updateElement('ownProducts', stats.own_products_count || 0);
            updateElement('occupancyRate', `${stats.occupancy_rate || 0}%`);
            updateElement('areaUtilization', `${stats.area_utilization || 0}%`);
            
            // サイズ分布
            updateElement('smallProducts', stats.size_distribution?.small || 0);
            updateElement('mediumProducts', stats.size_distribution?.medium || 0);
            updateElement('largeProducts', stats.size_distribution?.large || 0);
        })
        .catch(error => {
            console.error('Stats update error:', error);
        });
}

// 要素更新ヘルパー
function updateElement(id, value) {
    const element = document.getElementById(id);
    if (element) {
        element.textContent = value;
    }
}

// ローディングインジケーター
function showLoadingIndicator(row, column) {
    const cell = document.querySelector(`[data-row="${row}"][data-column="${column}"]`);
    if (cell) {
        cell.style.backgroundColor = '#e7f1ff';
        cell.innerHTML = '<div class="text-center"><i class="bi bi-arrow-repeat" style="animation: spin 1s linear infinite;"></i></div>';
    }
}

function hideLoadingIndicator() {
    // 必要に応じて実装
}

// トースト通知
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="bi bi-${type === 'error' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
            ${message}
        </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// ドラッグ状態クリア
function clearDragState() {
    draggedProduct = null;
    document.body.classList.remove('dragging-mode');
    
    // プレビューをクリア
    if (currentPreview) {
        currentPreview.remove();
        currentPreview = null;
    }
}

// その他の関数は省略（必要に応じて実装）
function initializeSizeAwareDragDrop() {
    console.log('Initializing size-aware drag and drop');
}

function setupSizeModalSearch() {
    console.log('Setting up size modal search');
}

function toggleSizeIndicators() {
    console.log('Toggling size indicators');
}

function toggleGridLines() {
    console.log('Toggling grid lines');
}

function resetView() {
    console.log('Resetting view');
}

function saveShelfLayout() {
    showToast('レイアウトを保存しました', 'success');
}

function optimizeLayout() {
    showToast('レイアウト最適化機能は開発中です', 'info');
}

function toggleProductPanel() {
    showToast('商品パネル機能は開発中です', 'info');
}

function selectPlacement(element) {
    // 選択状態を更新
    document.querySelectorAll('.product-placement').forEach(p => p.classList.remove('selected'));
    element.classList.add('selected');
    selectedPlacement = element;
}

function showPlacementContextMenu(event, element) {
    event.preventDefault();
    // コンテキストメニュー表示
}

function handleProductDragStart(event, element) {
    // 商品ドラッグ開始
}

function handleDrop(event, row, column) {
    event.preventDefault();
    // ドロップ処理
}

function handleDragOver(event, row, column) {
    event.preventDefault();
    // ドラッグオーバー処理
}

function handleDragLeave(event) {
    // ドラッグリーブ処理
}

function editFaceCount(placementId, currentCount) {
    const newCount = prompt('フェース数を入力してください:', currentCount);
    if (newCount && newCount !== currentCount.toString()) {
        // フェース数更新API呼び出し
        updateFaceCount(placementId, parseInt(newCount));
    }
}

function updateFaceCount(placementId, faceCount) {
    // フェース数更新実装
    showToast(`フェース数を${faceCount}に更新しました`, 'success');
}

// CSSアニメーション追加
const style = document.createElement('style');
style.textContent = `
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    .product-placement.selected {
        box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.5) !important;
        z-index: 25 !important;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}